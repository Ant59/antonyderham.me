<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Using NgRx Store Auth Token with Angular HttpInterceptor</title><style>html body{font-family:raleway,sans-serif;background-color:#fff}:root{--accent: #9C27B0;--border-width:  5px }</style><link rel=stylesheet href=https://antonyderham.me/css/main.css><link rel=stylesheet href=/css/figures.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script><meta name=generator content="Hugo 0.74.2"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-111367451-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','UA-111367451-1');</script></head><body><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>Using NgRx Store Auth Token with Angular HttpInterceptor</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/post/>Posts</a></li><li><a href=/project/>Projects</a></li></ul><ul class="nav navbar-nav navbar-right"><li class=navbar-icon><a href=mailto:antony@derham.me><i class="fa fa-envelope-o"></i></a></li><li class=navbar-icon><a href=https://github.com/ant59/><i class="fa fa-github"></i></a></li><li class=navbar-icon><a href=https://twitter.com/antonyderham/><i class="fa fa-twitter"></i></a></li><li class=navbar-icon><a href=https://www.linkedin.com/in/antonyderham/><i class="fa fa-linkedin"></i></a></li></ul></div></div></nav><main><div class=item><h4><a href=/post/angular-ngrx-auth-interceptor/>Using NgRx Store Auth Token with Angular HttpInterceptor</a></h4><h5>June 4, 2018</h5><kbd class=item-tag>angular</kbd> <kbd class=item-tag>ngrx</kbd> <kbd class=item-tag>store</kbd> <kbd class=item-tag>auth</kbd> <kbd class=item-tag>jwt</kbd> <kbd class=item-tag>http</kbd> <kbd class=item-tag>httpclient</kbd> <kbd class=item-tag>interceptor</kbd> <kbd class=item-tag>httpinterceptor</kbd></div><br><div class=text-justify><p>When using NgRx store, it&rsquo;s likely that you will save authentication tokens, such as a JWT, in the store. It&rsquo;s also likely that you want to send this token for many different requests that require authentication. Angular 4.3 introduced <code>HttpInterceptor</code>. This allows for registering an interceptor that will be called upon each request where the interceptor is injected.</p><p>To mix the two concepts together requires a bit of RxJS <code>flatMap</code>, since the intercept method on the interceptor interface takes the request object and handler and returns an observable. This is added to the chain of observables when making HttpClient requests.</p><p>Firstly, create the new interceptor.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>@Injectable</span>()
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TokenInterceptor</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>HttpInterceptor</span> {
  <span style=color:#a6e22e>intercept</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>HttpRequest</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>next</span>: <span style=color:#66d9ef>HttpHandler</span>) {

  }
}
</code></pre></div><p>Next, inject the NgRx Store for access to the token selector through the constructor parameters via dependency injection. I&rsquo;ll assume you have an existing token selector.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>@Injectable</span>()
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TokenInterceptor</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>HttpInterceptor</span> {
  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Store</span>&lt;<span style=color:#f92672>fromAuth.State</span>&gt;) {}

  <span style=color:#a6e22e>intercept</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>HttpRequest</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>next</span>: <span style=color:#66d9ef>HttpHandler</span>) {

  }
}
</code></pre></div><p>The observable that we return from the intercept method begins with the store selector. Since this observable will form part of the chain when creating a new HttpClient request and subscribing, we don&rsquo;t want to send an update everytime the token changes in the future, else the services using HttpClient will appear to get a new value from their request if not unsubscribed. Thus we use the <code>first()</code> operator here to only take the first value, then complete.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>@Injectable</span>()
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TokenInterceptor</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>HttpInterceptor</span> {
  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Store</span>&lt;<span style=color:#f92672>fromAuth.State</span>&gt;) {}

  <span style=color:#a6e22e>intercept</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>HttpRequest</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>next</span>: <span style=color:#66d9ef>HttpHandler</span>) {
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>select</span>(<span style=color:#a6e22e>fromAuth</span>.<span style=color:#a6e22e>getToken</span>).<span style=color:#a6e22e>pipe</span>(
      <span style=color:#a6e22e>first</span>(),
      ...
    );
  }
}
</code></pre></div><p>Finally, the logic itself via the <code>flatMap</code> operator, which will take our token value from the selector observable and allow us to return a new observable, which is provided by the HttpHandler, using a clone of the request as a parameter. This clone has the <code>Authorization</code> header set with our token as the value. Here I&rsquo;m using a JWT and therefore prefix with <code>Bearer</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>@Injectable</span>()
<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TokenInterceptor</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>HttpInterceptor</span> {
  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Store</span>&lt;<span style=color:#f92672>fromAuth.State</span>&gt;) {}

  <span style=color:#a6e22e>intercept</span>(<span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>HttpRequest</span>&lt;<span style=color:#f92672>any</span>&gt;, <span style=color:#a6e22e>next</span>: <span style=color:#66d9ef>HttpHandler</span>) {
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>select</span>(<span style=color:#a6e22e>fromAuth</span>.<span style=color:#a6e22e>getToken</span>).<span style=color:#a6e22e>pipe</span>(
      <span style=color:#a6e22e>first</span>(),
      <span style=color:#a6e22e>flatMap</span>(<span style=color:#a6e22e>token</span> <span style=color:#f92672>=&gt;</span> {
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authReq</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!!</span><span style=color:#a6e22e>token</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>clone</span>({
          <span style=color:#a6e22e>setHeaders</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>Authorization</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Bearer &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>token</span> },
        }) <span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>;
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>next</span>.<span style=color:#a6e22e>handle</span>(<span style=color:#a6e22e>authReq</span>);
      }),
    );
  }
}
</code></pre></div><p>With the interceptor complete, the final thing to do is provide the interceptor to the <code>HTTP_INTERCEPTORS</code> InjectionToken where we want to inject it, such as the NgModule or service that we want to add our token to requests for.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#a6e22e>providers</span><span style=color:#f92672>:</span> [
  {<span style=color:#a6e22e>provide</span>: <span style=color:#66d9ef>HTTP_INTERCEPTORS</span>, <span style=color:#a6e22e>useClass</span>: <span style=color:#66d9ef>TokenInterceptor</span>, <span style=color:#a6e22e>multi</span>: <span style=color:#66d9ef>true</span>},
],
</code></pre></div></div><h4 class=page-header>Related</h4><div class=item><h4><a href=/post/angular-file-input/>Dealing with file inputs in Angular 6</a></h4><h5>June 1, 2018</h5><kbd class=item-tag>angular</kbd> <kbd class=item-tag>form</kbd> <kbd class=item-tag>input</kbd> <kbd class=item-tag>file</kbd> <kbd class=item-tag>directive</kbd> <kbd class=item-tag>control</kbd> <kbd class=item-tag>accessor</kbd> <kbd class=item-tag>upload</kbd></div><div class=item><h4><a href=/post/jenkins-docker-pipelines/>Declarative Jenkins Docker Pipeline for Angular CLI applications</a></h4><h5>January 1, 2018</h5><kbd class=item-tag>jenkins</kbd> <kbd class=item-tag>docker</kbd> <kbd class=item-tag>angular</kbd> <kbd class=item-tag>pipeline</kbd></div><h4 class=page-header>Comments</h4><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"antonyderham"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main><footer><p class="copyright text-muted">© All rights reserved. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/calintat/minimal>Minimal</a></p></footer></body></html>